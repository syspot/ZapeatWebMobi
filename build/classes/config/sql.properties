# Configuracao do framework topsys.

JNDI.CONNECTION java:comp/env/jdbc/ZapeatSiteDS

CLASS.BROKER.IMPL br.com.topsys.database.jdbc.TSDataBaseBrokerImpl

CLASS.SEQUENCE.IMPL br.com.topsys.database.jdbc.sequence.TSSequencePostgresImpl

CODIGO.UNIQUE 23505

CODIGO.FOREIGNKEY 23503

#CategoriaDAO
categoriadao.pesquisar=SELECT C.ID,C.DESCRICAO,C.IMAGEM,(SELECT COUNT(*) FROM PROMOCOES P,FORNECEDORES_CATEGORIAS F WHERE CASE P.TIPO_PROMOCAO_ID WHEN 1 THEN ((P.INICIO IS NULL OR P.INICIO <=  CURRENT_TIMESTAMP) AND (P.FIM IS NULL OR  P.FIM >= CURRENT_TIMESTAMP)) ELSE ((P.INICIO IS NULL OR CAST(P.INICIO AS DATE) <= CURRENT_DATE) AND (P.FIM IS NULL OR  CAST(P.FIM AS DATE) >= CURRENT_DATE)) END AND P.FORNECEDOR_CATEGORIA_ID = F.ID AND F.CATEGORIA_ID = C.ID) FROM CATEGORIAS C WHERE C.FLAG_ATIVO ORDER BY C.DESCRICAO
categoriadao.obter=SELECT ID,DESCRICAO FROM CATEGORIAS WHERE ID=?

#PromocaoDAO
promocaodao.pesquisar=SELECT P.ID,P.DESCRICAO,T.ID,T.DESCRICAO,F.ID,F.NOME_FANTASIA,F.CEP,F.LOGRADOURO,F.NUMERO,F.BAIRRO,C.NOME,P.INICIO,P.FIM,P.PRECO_ORIGINAL,P.PRECO_PROMOCIONAL,P.TITULO,P.IMAGEM_THUMB,CAT.DESCRICAO,(SELECT COALESCE(COUNT(*),0) FROM INDICACOES COM WHERE COM.FORNECEDOR_ID = F.ID AND COM.FLAG_INDICA) FROM PROMOCOES P,TIPOS_PROMOCOES T,FORNECEDORES F,FORNECEDORES_CATEGORIAS FC,CIDADES C,CATEGORIAS CAT WHERE F.ID = FC.FORNECEDOR_ID AND F.CIDADE_ID = C.ID AND P.TIPO_PROMOCAO_ID = T.ID AND FC.ID = P.FORNECEDOR_CATEGORIA_ID AND FC.CATEGORIA_ID = CAT.ID AND P.FORNECEDOR_CATEGORIA_ID = FC.ID AND FC.CATEGORIA_ID = 1 AND CASE T.ID WHEN 1 THEN ((INICIO IS NULL OR INICIO <=  CURRENT_TIMESTAMP) AND (FIM IS NULL OR  FIM >= CURRENT_TIMESTAMP)) ELSE ((INICIO IS NULL OR CAST(INICIO AS DATE) <= CURRENT_DATE) AND (FIM IS NULL OR  CAST(FIM AS DATE) >= CURRENT_DATE)) END  AND (? IS NULL OR distanceInKm(F.LATITUDE,F.LONGITUDE,?,?) >= ?)
promocaodao.obter=SELECT P.ID, P.TIPO_PROMOCAO_ID, TP.DESCRICAO, F.ID, F.NOME_FANTASIA, P.DESCRICAO, P.INICIO, P.FIM, P.PRECO_ORIGINAL, P.PRECO_PROMOCIONAL, P.TITULO, F.LONGITUDE, F.LATITUDE,CID.NOME,ES.SIGLA,F.LOGRADOURO,F.NUMERO,F.CEP,F.BAIRRO,F.TELEFONE, (SELECT COALESCE(COUNT(*),0) FROM INDICACOES COM WHERE COM.FORNECEDOR_ID = F.ID AND COM.FLAG_INDICA),EXISTS(SELECT 1 FROM INDICACOES COM,USUARIOS_SITE US WHERE US.ID = COM.USUARIO_ID AND COM.FORNECEDOR_ID = F.ID AND COM.FLAG_INDICA AND US.TOKEN = ?), EXISTS(SELECT 1 FROM INDICACOES COM,USUARIOS_SITE US WHERE US.ID = COM.USUARIO_ID AND COM.FORNECEDOR_ID = F.ID AND COM.FLAG_NAO_INDICA AND US.TOKEN = ?), CASE  WHEN P.PRECO_ORIGINAL IS NULL  OR P.PRECO_ORIGINAL=0 THEN 0 ELSE ROUND( CAST((100 - (P.PRECO_PROMOCIONAL / P.PRECO_ORIGINAL * 100)) AS NUMERIC),2) END,F.LOGOMARCA FROM PUBLIC.PROMOCOES P, TIPOS_PROMOCOES TP, FORNECEDORES F,CIDADES CID, ESTADOS ES,FORNECEDORES_CATEGORIAS FC WHERE P.TIPO_PROMOCAO_ID = TP.ID AND P.FORNECEDOR_CATEGORIA_ID = FC.ID AND FC.FORNECEDOR_ID = F.ID AND F.CIDADE_ID = CID.ID AND CID.ESTADO_ID = ES.ID AND P.ID=?
promocaodao.usuario.pesquisar=SELECT P.ID,P.DESCRICAO,F.NOME_FANTASIA,P.TITULO,P.PRECO_ORIGINAL,P.PRECO_PROMOCIONAL,P.INICIO,P.FIM,F.LATITUDE,F.LONGITUDE FROM PROMOCOES P,TIPOS_PROMOCOES T,FORNECEDORES F,FORNECEDORES_CATEGORIAS FC,CIDADES C,CATEGORIAS CAT WHERE F.ID = FC.FORNECEDOR_ID AND F.CIDADE_ID = C.ID AND P.TIPO_PROMOCAO_ID = T.ID  AND FC.CATEGORIA_ID = CAT.ID AND P.FORNECEDOR_CATEGORIA_ID = FC.ID AND (P.INICIO IS NULL OR P.INICIO <= CURRENT_DATE) AND (P.FIM IS NULL OR  P.FIM >= CURRENT_DATE)
promocaodao.menu.pesquisar=SELECT P.ID,P.DESCRICAO,T.ID,T.DESCRICAO,F.ID,F.NOME_FANTASIA,F.CEP,F.LOGRADOURO,F.NUMERO,F.BAIRRO,C.NOME,P.INICIO,P.FIM,P.PRECO_ORIGINAL,P.PRECO_PROMOCIONAL,P.TITULO,P.IMAGEM_THUMB,CAT.DESCRICAO,(SELECT COALESCE(COUNT(*),0) FROM INDICACOES COM WHERE COM.FORNECEDOR_ID = F.ID AND COM.FLAG_INDICA) FROM PROMOCOES P,TIPOS_PROMOCOES T,FORNECEDORES F,FORNECEDORES_CATEGORIAS FC,CIDADES C,CATEGORIAS CAT WHERE F.ID = FC.FORNECEDOR_ID AND F.CIDADE_ID = C.ID AND P.TIPO_PROMOCAO_ID = T.ID AND F.ID = FC.FORNECEDOR_ID AND FC.CATEGORIA_ID = CAT.ID  AND (INICIO IS NULL OR INICIO <= CURRENT_DATE) AND (FIM IS NULL OR  FIM >= CURRENT_DATE) AND P.FORNECEDOR_CATEGORIA_ID = FC.ID AND (SEM_ACENTOS(P.DESCRICAO) ILIKE ? OR SEM_ACENTOS(F.NOME_FANTASIA) ILIKE ? OR SEM_ACENTOS(P.TITULO) ILIKE ? OR SEM_ACENTOS(C.NOME) ILIKE ?)

#IndicacaoDAO
indicacaodao.inserir=INSERT INTO INDICACOES(ID,FORNECEDOR_ID,USUARIO_ID,FLAG_INDICA,FLAG_NAO_INDICA,DESCRICAO,DATA_CADASTRO) VALUES(?, ?, ?, ?, ?, ?, ?)
indicacaodao.obter=SELECT ID,FLAG_INDICA,FLAG_NAO_INDICA FROM INDICACOES WHERE FORNECEDOR_ID=? AND USUARIO_ID=?
#FornecedorDAO
fornecedordao.obter=SELECT F.ID,F.NOME_FANTASIA,F.LATITUDE,F.LONGITUDE,C.NOME,E.SIGLA,F.LOGRADOURO,F.NUMERO,F.CEP,F.BAIRRO,F.TELEFONE,(SELECT COALESCE(COUNT(*),0) FROM INDICACOES COM WHERE COM.FORNECEDOR_ID = F.ID AND COM.FLAG_INDICA),EXISTS(SELECT 1 FROM INDICACOES COM,USUARIOS_SITE US WHERE US.ID = COM.USUARIO_ID AND COM.FORNECEDOR_ID = F.ID AND COM.FLAG_INDICA  AND US.TOKEN = ?),EXISTS(SELECT 1 FROM INDICACOES COM,USUARIOS_SITE US WHERE US.ID = COM.USUARIO_ID AND COM.FORNECEDOR_ID = F.ID AND COM.FLAG_NAO_INDICA  AND US.TOKEN = ?),F.IMAGEM_THUMB FROM FORNECEDORES F,CIDADES C,ESTADOS E WHERE F.CIDADE_ID = C.ID AND C.ESTADO_ID = E.ID AND F.ID = ?

#UsuarioDAO
usuariodao.obteracesso=SELECT ID,NOME,TOKEN,FLAG_ATIVO FROM USUARIOS_SITE WHERE EMAIL=? AND SENHA=?
usuariodao.obterportoken=SELECT ID,NOME,TOKEN FROM USUARIOS_SITE WHERE TOKEN=? AND FLAG_ATIVO
usuariodao.obterporemail=SELECT ID,NOME,TOKEN,SENHA FROM USUARIOS_SITE WHERE EMAIL=? AND FLAG_ATIVO
usuariodao.inserir=INSERT INTO PUBLIC.USUARIOS_SITE (ID, NOME, EMAIL, SENHA, FLAG_ATIVO, IMAGEM, TOKEN, FLAG_FACEBOOK, FLAG_ACEITOU_TERMO) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
usuariodao.obter=SELECT ID, NOME, EMAIL, SENHA, FLAG_ATIVO, IMAGEM, FLAG_ACEITOU_TERMO,token FROM PUBLIC.USUARIOS_SITE WHERE EMAIL = ?
usuariodao.obterbyid=SELECT ID, NOME, EMAIL, SENHA, FLAG_ATIVO, IMAGEM, FLAG_ACEITOU_TERMO,token FROM PUBLIC.USUARIOS_SITE WHERE ID = ?
usuariodao.alterar=UPDATE PUBLIC.USUARIOS_SITE SET NOME = ? WHERE ID = ?
usuariodao.aceitartermouso=UPDATE USUARIOS_SITE SET FLAG_ACEITOU_TERMO=TRUE WHERE ID = ?
#ComentarioDAO
comentariodao.pesquisarpromocao=SELECT C.ID,C.DESCRICAO,C.PROMOCAO_ID,U.NOME,C.DATA_CADASTRO FROM COMENTARIOS_PROMOCOES C,USUARIOS_SITE U WHERE C.USUARIO_ID = U.ID AND C.PROMOCAO_ID=? AND C.FLAG_ATIVO ORDER BY C.DATA_CADASTRO DESC
comentariodao.inserir=INSERT INTO COMENTARIOS_PROMOCOES(USUARIO_ID,DESCRICAO,DATA_CADASTRO,PROMOCAO_ID) VALUES(?,?,?,?)

#FormaPagamentoDAO
formapagamentodao.pesquisar=SELECT FP.ID,FP.IMAGEM FROM FORMAS_PAGAMENTOS FP, FORNECEDORES_FORMAS_PAGAMENTOS FFP WHERE FFP.FORMA_PAGAMENTO_ID = FP.ID AND FFP.FORNECEDOR_ID=?